---
tags: [前端, sso]
date: 26.1.29
---

# SSO 认证与 Token 换签（Token Exchange）

在单点登录（Single Sign-On, SSO）体系下，Token 换签（Token Exchange）与普通 Token 刷新（Refresh Token）不同。Token Exchange 不是简单续期 access_token，而是针对「用户更换身份」或「切换上下文」时，在不同的可信应用/资源方之间用已有 Token 换取其他作用域/身份的 Token，或者获得更高或更低权限的新的 Token。

## 场景举例

- 用户在平台已登录（有统一登录态 Token），访问某个子系统/服务，需要该服务的专属 Token，进行权限壁垒隔离。
- 一个后台管理者需要以“客户身份”切换/代入子账户，临时用自己 Token 换取下属用户的 Token。
- 在 OAuth2.0 下的 Token Exchange 扩展（RFC 8693）：允许一个已认证 Token，交换成另一个上下文/权限的 Token，做到最小权限原则。

## 核心流程

1. 客户端持有现有 token，比如 SSO 登录后的 access_token；
2. 当需要进入新的子系统或切换身份时，向认证中心发起「Token Exchange」请求；
3. 后端校验原 Token 的合法性和可换签权限，生成新的目标 Token，返回给客户端；
4. 客户端用新 Token 访问新系统/子系统，原 Token 仍按原作用域使用。

## 示例（伪代码）

```js
// 假设已登录，有 sso_access_token
async function exchangeToken(targetSystem) {
  const resp = await fetch('/api/token/exchange', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${getSsoAccessToken()}`
    },
    body: JSON.stringify({ audience: targetSystem })
  });
  if (!resp.ok) throw new Error('Token exchange failed');
  const { newToken } = await resp.json();
  return newToken;
}

// 用新 token 访问目标系统
const specialToken = await exchangeToken('data-analytics');
fetch('https://data-analytics.yoursaas.com/api/xxx', {
  headers: { 'Authorization': `Bearer ${specialToken}` }
});
```

## 前端开发注意

- exchange token 实际调用的接口应该由服务器统一提供，且**一定要走 https**；
- exchange-token 过程本身无法续签；若新 token 过期需重新换签，不宜长期复用；
- 不同系统/权限对应不同 audience/scopes，后端须做严格校验；
- 不推荐把 token 直接暴露给 URL，建议仅存于内存或受控存储。

## 换签得到的token目标系统不认是什么情况
// 若目标系统收到“换签”得到的新 token 仍提示未认证、token 无效通常有几个排查方向：
//
// 1. audience（aud/audiences）参数不对：换签时传递的目标系统标识（如 'data-analytics'）须与目标系统验证时期望的 audience 完全一致，否则新 token 会被判为无效。
// 2. token exchange 返回的新 token scope/claim 未授权目标系统：需确认换签接口下发的 scope/claim 包含目标系统要求的权限、角色或其他标识。
// 3. token 签名不被目标系统识别：一般出现在 SSO 配置多套密钥、环境隔离（如测试与生产私钥不同），需确认新 token 的签名算法及秘钥被目标系统验签端认可。
// 4. token 没有同步到目标资源方：如果后台为了防止 token 滥用临时加了黑名单/灰名单/缓存策略，目标系统还未感知新 token。
// 5. 时间问题：token 的 nbf（Not Before）/exp（过期）字段有时间误差，目标服务校验时间过严（时钟不同步），会导致新 token 暂时无效。
// 6. 目标系统有独立的 session/token 管理：即使新 token 合规，但目标系统还维护本地 session 等信息，也可能会导致认证失败，需要联调排查。

## 应用A的token换取到应用B的token，访问网关上的应用B接口提示未登录，常见排查思路

1. **Token 是否正确换签给了应用B**  
   - 检查换签时 `audience` 参数是否准确填写为应用B标识（如服务名、Client ID），与网关及应用B侧 token 校验配置完全一致。
   - 验证换签接口返回的新 token 是否有应用B需求的 scope/claim（如 roles、perm）。

2. **Token 实际带上没？**  
   - 分析前端调用接口时，是否将新 token 通过 `Authorization: Bearer xxx` 正确放在了请求头。
   - 浏览器/客户端是否未被重定向或篡改掉 headers。

3. **网关转发与鉴权配置**  
   - 网关（如 API Gateway、Ingress、Nginx 等）代理应用B接口时，是否有独立的认证规则，导致不识别新 token。
   - 网关侧的 public key/jwk 列表是否包含签发新 token 的密钥，有无时钟同步。

4. **Token 签名和算法、密钥同步**
   - 检查新 token 的签名算法是否和网关/应用B端支持的一致。
   - 如果有密钥变更或多环境，请确认网关缓存了最新的公钥，并能正确验签。

5. **token claim/过期时间问题**
   - 新 token 的 `nbf`（Not Before）/`exp` 是否合理，有无时区问题。
   - 网关和应用B服务器的时间需保持同步，否则刚换签的 token 可能会被直接当作「未生效」或「已过期」。

6. **Session 与本地认证逻辑**
   - 某些应用/网关除了校验 token，还查本地 session/cookie，如缺少 session 初始化或状态仍要求重登。
   - 某些接口需额外头部/参数协同认证，单凭 token 不足以识别登录。

7. **其他问题**
   - 应用B接口本身有灰度/隔离、IP 白名单等策略，导致即便 token 有效依然未放行。
   - 后端异常/网关跨域问题等影响了认证链路。

> 建议配合抓包、日志分析工具，分别核查「token 换签-前端带 token-网关验 token-应用B处理」每一步，逐步定位问题点。


## 网关的作用
网关在体系中的作用可总结为：

1. **统一入口/安全屏障**  
   网关（如 API Gateway、Nginx 反向代理、Ingress 等）作为所有微服务接口的唯一暴露入口，对外隐藏后端具体服务，实现统一鉴权、限流、安全规则配置，是整个系统的“第一道门”。

2. **路由转发**  
   根据不同的 URL 路径、主机名、请求头等，不同请求可被分发到对应后端服务，实现灵活的路由策略（支持 A/B 分流、蓝绿发布等）。

3. **鉴权与认证**  
   网关可以统一校验 token 的有效性、签名、scope/claim、过期等，大幅减少各后端重复实现，降低遗漏和安全风险（如 JWT/JWK 验证、OAuth2/SAML/自有协议等）。

4. **请求改写/增强**  
   支持在转发前后对请求/响应做增强，如自动补充头部，下游服务鉴权所需参数，统一的错误处理、协议转换、CORS 配置等。

5. **安全/流控**  
   实现高并发下的限流、黑白名单、IP 过滤、DDoS 基础防护等功能，是重要的风险防线之一。

6. **监控与日志**  
   统一记录所有经过网关的请求/响应数据、鉴权结果、请求耗时等，便于故障排查和安全审计。

7. **服务编排与聚合**  
   某些场景下，网关可对多个后端接口结果做聚合、合并、排序，实现“同一接口拉多项数据”以减少前端请求数。

**图示：**

```text
                 ┌─────────────┐
                 │   前端/客户端  │ 
                 └────┬────────┘
                      │
                 ┌────▼───────┐
                 │   网关    │（统一鉴权/路由/安全）
                 └─┬───────▲─┘
                   │       │
        ┌──────────▼┐   ┌──▼──────────┐
        │  应用A     │   │   应用B      │
        └───────────┘   └─────────────┘
```

**简而言之**：网关是应用间 token、权限“换签”及接口安全的枢纽。如果 token 换签后访问网关失败，重点先查「网关本身的鉴权、密钥、路由、安全设置」，其次再查应用后端，实现更高效的定位和处置。



## 拓展阅读

- [OAuth 2.0 Token Exchange (RFC 8693)](https://datatracker.ietf.org/doc/html/rfc8693)
- 常见 SSO 平台（如 Keycloak, Authing, Auth0 等）都支持 token exchange 场景。
